extends Node2D

# Set this constant before the game starts
const in_edit_mode: bool = false
var current_level_name = "AGGRESSIVE"

const init_y_pos = -360
const pass_y = 509
@export var fall_speed: float = 434.5

# Time it takes for falling key to reach critical spot
var fk_fall_time: float
var fk_output_arr = [[], [], [], []]

var level_info = {
	"DUCKAGEDDON" = {
		"fk_times": "[[-0.4413605928421, 1.16081643104553, 2.92553281784058, 3.22739219665527, 5.21269845962524, 5.52616786956787, 5.79319715499878, 6.12988662719727, 6.42013645172119, 6.72199535369873, 7.07029438018799, 8.28934288024902, 9.58965969085693, 10.9480276107788, 12.7475738525391, 13.0842628479004, 15.3830394744873, 15.7313385009766, 18.0301132202148, 18.3668022155762, 20.7004089355469, 21.0603179931641, 22.6857147216797, 24.032470703125, 28.6880722045898, 29.047981262207, 29.3614521026611, 29.6981410980225, 34.3537406921387, 34.6556015014648, 35.015510559082, 38.0108833312988, 38.3359642028809, 38.6726531982422, 39.0441741943359, 42.0279350280762, 42.3414077758789, 42.6664848327637, 43.003173828125, 61.9854888916016, 66.664306640625], [0.51065754890442, 8.92789077758789, 9.93795871734619, 16.7297954559326, 17.0664844512939, 21.3621768951416, 21.7104759216309, 23.0340137481689, 24.369161605835, 31.3583679199219, 31.6950569152832, 32.0433578491211, 32.3568267822266, 39.322811126709, 39.647891998291, 39.9961891174316, 40.332878112793, 44.6517906188965, 45.3019485473633, 45.9985504150391, 46.6138763427734, 47.3336944580078, 47.9954643249512, 48.6572341918945], [-0.10467123985291, 0.81251692771912, 1.50911569595337, 1.86902499198914, 2.24054431915283, 2.58884334564209, 7.34893417358398, 7.65079402923584, 7.96426296234131, 9.22975063323975, 10.6113376617432, 11.3427667617798, 11.691065788269, 12.0625848770142, 12.3992748260498, 13.4093427658081, 13.7460317611694, 14.6980495452881, 15.0463485717773, 16.0331974029541, 16.4047164916992, 17.4031753540039, 17.7050342559814, 18.6686630249023, 19.0285720825195, 20.0270290374756, 20.3869380950928, 22.3490257263184, 23.6957817077637, 27.3645343780518, 27.7128353118896, 28.049524307251, 28.3746032714844, 30.0696601867676, 30.3483009338379, 30.6849899291992, 31.0216789245605, 32.6586837768555, 33.0302047729492, 33.355281829834, 33.680362701416, 33.9938316345215, 34.3421325683594, 34.6556015014648, 35.015510559082, 35.3638076782227, 35.7121086120605, 35.9907493591309, 36.3390464782715, 40.6695709228516, 40.9946479797363, 41.3313369750977, 41.6796379089355, 43.328254699707, 43.6533317565918, 44.0016326904297, 44.338321685791, 44.9884796142578, 45.673469543457, 46.3236274719238, 46.9853973388672, 47.6471672058105, 48.3437652587891, 51.4320182800293, 51.6526069641113, 51.9892959594727, 52.3143768310547, 52.6742858886719, 52.8368263244629, 53.0922431945801, 53.3708839416504, 53.6727447509766, 54.0210418701172, 54.3112907409668, 54.6479835510254, 54.9846725463867, 55.1820411682129, 55.321361541748, 55.6348304748535, 55.9715194702148, 56.2966003417969, 56.6448974609375, 56.9815864562988, 57.2950553894043, 57.6201362609863, 57.9452171325684, 58.2819061279297, 58.618595123291, 58.9552841186523, 59.2803611755371, 59.4777336120605, 59.6402702331543, 59.791202545166, 59.953742980957, 60.1511116027832, 60.3484802246094, 60.638729095459, 60.963809967041, 61.2888870239258, 61.6487998962402, 66.664306640625], [0.19718813896179, 3.57569169998169, 3.91238117218018, 4.30712032318115, 4.59736967086792, 4.92244911193848, 8.61442184448242, 10.251428604126, 14.0711116790771, 14.3961906433105, 19.3304309844971, 19.6555099487305, 22.0355548858643, 23.3474826812744, 24.7174606323242, 25.0425395965576, 25.3908386230469, 25.7043075561523, 26.0526084899902, 26.3892974853516, 26.7259864807129, 27.0742855072021, 36.652515411377, 37.0008163452148, 37.3375053405762, 37.6509742736816]]",
		"music": load("res://assets/music/bruhduck.mp3")
	},
	"AGGRESSIVE" = {
		"fk_times": "[[2.25795936584473, 3.93269824981689, 5.46811771392822, 5.77868461608887, 6.12988662719727, 7.78140544891357, 7.96426296234131, 8.12390041351318, 8.28353786468506, 8.45478439331055, 8.62603187561035, 8.76535129547119, 9.14848041534424, 9.27619075775146, 9.42421722412109, 9.55482959747314, 9.70285701751709, 9.83056735992432, 9.96988677978516, 16.018684387207, 16.0506114959717, 16.413423538208, 16.7646255493164, 16.9242630004883, 19.7280731201172, 20.0705661773682, 20.4014511108398, 20.8919734954834, 21.6930618286133, 22.0558738708496, 23.7073917388916, 24.2733783721924, 24.3894786834717, 24.7319736480713, 25.7130165100098, 26.6621322631836, 26.7056694030762, 27.0249423980713, 27.3761444091797, 30.0435371398926, 30.3628120422363, 30.5456695556641, 30.6936950683594, 31.0478019714355, 33.0302047729492, 38.4375495910645, 38.6000900268555, 39.0267562866211, 39.4940605163574, 39.6856231689453, 39.8452606201172, 40.8495254516602, 43.6330146789551, 45.510929107666, 47.687801361084, 48.2189559936523, 49.0403633117676, 49.9169158935547, 51.6758270263672, 51.8354644775391, 52.0270309448242, 52.3579139709473, 52.677188873291, 52.839729309082, 53.0080718994141, 53.3389587402344, 53.6814498901367, 53.9687995910645, 54.1284370422363, 58.2238540649414, 59.6431732177734, 62.3308868408203], [-0.37750566005707, 0.12462592124939, 0.27265310287476, 0.61514735221863, 1.42494320869446, 1.57587289810181, 1.93868470191956, 6.46077060699463, 6.6204080581665, 6.76843547821045, 6.92807292938232, 7.07900238037109, 7.22702980041504, 7.40988636016846, 11.7607259750366, 11.94358253479, 12.1235370635986, 12.4544219970703, 12.764988899231, 12.9246253967285, 17.0722904205322, 17.4031753540039, 17.7456684112549, 18.2245807647705, 18.4074382781982, 22.3954639434814, 22.5551013946533, 22.6828117370605, 23.0369167327881, 23.3765087127686, 23.5361442565918, 26.6621322631836, 28.8825397491455, 29.0421772003174, 29.2018146514893, 29.3730621337891, 29.7242622375488, 31.5267105102539, 31.7066650390625, 31.8575973510742, 32.0491600036621, 32.3916549682617, 34.1621780395508, 35.6772804260254, 37.2010879516602, 38.2053527832031, 38.364990234375, 42.0221328735352, 42.161449432373, 42.3326988220215, 42.4720191955566, 42.6838989257813, 43.003173828125, 44.1554641723633, 45.3280715942383, 46.7909278869629, 47.687801361084, 48.6891593933105, 49.7572784423828, 50.4712944030762, 50.6309280395508, 50.8108825683594, 50.9821319580078, 51.1736946105957, 51.3333320617676, 54.3316116333008, 54.6828117370605, 54.9933776855469, 55.3242645263672, 55.922176361084, 55.974422454834, 56.3372344970703, 57.3385925292969, 58.2238540649414, 60.6039009094238, 60.775146484375], [-1.31501132249832, -0.97541952133179, -0.68517005443573, -0.21786844730377, 0.94603180885315, 1.09405899047852, 6.46077060699463, 6.6204080581665, 6.76843547821045, 6.92807292938232, 7.07900238037109, 7.2502498626709, 7.40988636016846, 9.16879844665527, 9.3603630065918, 9.48807239532471, 9.62739181518555, 9.75510215759277, 9.89442157745361, 10.0453510284424, 10.4284811019897, 15.388843536377, 16.018684387207, 18.0649433135986, 18.4074382781982, 18.7063941955566, 18.8660316467285, 19.0459861755371, 19.2172336578369, 19.3768711090088, 19.5365085601807, 22.3867568969727, 22.6828117370605, 23.0369167327881, 23.3765087127686, 23.5361442565918, 26.6621322631836, 27.7186393737793, 30.1712455749512, 31.3554649353027, 32.8705673217773, 33.1898422241211, 33.3610877990723, 33.7035827636719, 34.3740577697754, 34.8442611694336, 35.0038986206055, 36.2839012145996, 36.9137420654297, 37.2010879516602, 37.360725402832, 37.6916084289551, 38.0341033935547, 43.3456687927246, 43.4849891662598, 44.3586387634277, 44.5937423706055, 45.7228126525879, 46.1814041137695, 47.0985946655273, 47.687801361084, 47.856143951416, 48.3785934448242, 48.561450958252, 49.3190040588379, 50.1287994384766, 54.3316116333008, 54.6828117370605, 54.9933776855469, 55.3242645263672, 55.922176361084, 55.974422454834, 56.3372344970703, 57.6491622924805, 58.2238540649414, 58.3312454223633, 58.482177734375, 58.650520324707, 58.813060760498, 58.9726982116699, 59.1526527404785, 59.323902130127, 59.4719276428223, 60.0059852600098, 60.9463958740234, 61.126350402832, 61.2859878540039, 61.4688453674316, 61.6284790039063, 61.8200454711914, 61.9912910461426], [2.41759634017944, 3.13160991668701, 3.27092981338501, 4.53931951522827, 5.16916084289551, 5.46811771392822, 5.77868461608887, 6.12988662719727, 7.78140544891357, 7.96426296234131, 8.12390041351318, 8.28353786468506, 8.45478439331055, 8.62603187561035, 8.7740592956543, 13.0842628479004, 13.65895652771, 13.7547388076782, 14.0856227874756, 14.7793197631836, 20.7642631530762, 21.071928024292, 21.2431755065918, 21.402811050415, 21.71337890625, 22.0558738708496, 23.7073917388916, 24.2733783721924, 24.3894786834717, 24.7203636169434, 26.0322895050049, 26.6621322631836, 26.7056694030762, 27.0249423980713, 27.355827331543, 27.8782768249512, 28.037914276123, 28.3687973022461, 28.7112922668457, 32.6993179321289, 34.0344657897949, 39.3460311889648, 40.0281181335449, 40.3386840820313, 40.657958984375, 41.0294799804688, 41.2007255554199, 41.3516540527344, 41.6506118774414, 43.8245811462402, 44.007438659668, 45.3280715942383, 47.687801361084, 48.0273933410645, 49.4989585876465, 50.2565078735352, 51.6758270263672, 51.8354644775391, 52.0270309448242, 52.3579139709473, 52.677188873291, 52.839729309082, 53.0080718994141, 53.3389587402344, 53.6611328125, 53.9687995910645, 54.1400451660156, 58.2238540649414, 60.3049430847168, 62.3308868408203]]
404, 9.46775531768799, 9.63900184631348, 9.78702926635742, 9.93795871734619, 10.0975961685181, 10.2369165420532, 14.2481632232666, 14.4078006744385, 14.5761451721191, 14.7706127166748, 15.1421318054199, 15.4410877227783, 15.6007251739502, 15.7922897338867, 15.9432201385498, 16.1144676208496, 16.4453506469727, 16.7530155181885, 20.923900604248, 21.0951480865479, 21.4347400665283, 24.7116546630859, 28.3368701934814, 28.9551029205322, 29.3933792114258, 34.2028121948242, 34.3653526306152, 34.5249900817871, 34.684627532959, 35.0358276367188, 35.3551025390625, 39.6769142150879, 39.8133316040039, 39.9642639160156, 40.327075958252, 40.6898880004883, 40.8379135131836, 43.9755096435547, 44.143856048584, 46.3323364257813, 46.4919738769531, 48.3379592895508, 48.9561920166016, 49.4147834777832, 51.6961441040039, 51.8673934936523, 52.0270309448242, 52.3492050170898, 52.7120170593262, 52.839729309082, 54.0007247924805, 54.1516571044922, 54.3316116333008, 54.6828117370605, 55.0049896240234, 56.9873924255371, 57.5853042602539, 57.692699432373, 58.0119743347168, 58.482177734375, 59.570613861084, 59.5909309387207]]",
		"music": load("res://assets/music/bruhduck.mp3")
	}
}

func _ready():
	fk_fall_time = (pass_y - init_y_pos) / fall_speed
	
	$DuckMoosic.stream = level_info.get(current_level_name).get("music")
	$DuckMoosic.play()
	
	if in_edit_mode:
		Signals.KeyListenerPress.connect(KeyListenerPress)
	else:
		var fk_times = level_info.get(current_level_name).get("fk_times")
		var fk_times_arr = str_to_var(fk_times)
		
		var counter: int = 0
		for key in fk_times_arr:
			
			var button_name: String = ""
			match counter:
				0:
					button_name = "ui_left"
				1:
					button_name = "ui_down"
				2:
					button_name = "ui_up"
				3:
					button_name = "ui_right"
			
			for delay in key:
				SpawnFallingKey(button_name, delay)
			
			counter += 1

func KeyListenerPress(button_name: String, array_num: int):
	print(str(array_num) + " " + str($DuckMoosic.get_playback_position()))
	fk_output_arr[array_num].append($DuckMoosic.get_playback_position() - fk_fall_time)

func SpawnFallingKey(button_name: String, delay: float):
	await get_tree().create_timer(delay).timeout
	Signals.CreateFallingKey.emit(button_name)

func _on_duck_moosic_finished() -> void:
	print(fk_output_arr)
	get_tree().change_scene_to_file("res://scenes/menu.tscn")
